#!/usr/bin/env -S deno run --allow-read --allow-write

/**
 * Deno 2 Starter Customization Script
 * 
 * This script helps you quickly customize the starter template
 * by prompting for basic information and updating the config.
 * 
 * Usage: deno run --allow-read --allow-write scripts/customize.ts
 */

interface CustomizationAnswers {
  siteName: string;
  siteDescription: string;
  primaryColor: string;
  enableNotifications: boolean;
  enableTwoFactor: boolean;
  enableAdminPanel: boolean;
}

const colors = {
  blue: "#2563eb",
  green: "#059669", 
  purple: "#7c3aed",
  red: "#dc2626",
  orange: "#ea580c",
  pink: "#db2777",
  indigo: "#4f46e5",
  teal: "#0d9488",
};

async function prompt(message: string): Promise<string> {
  console.log(`\n${message}`);
  const buf = new Uint8Array(1024);
  const n = await Deno.stdin.read(buf) ?? 0;
  return new TextDecoder().decode(buf.subarray(0, n)).trim();
}

async function confirm(message: string): Promise<boolean> {
  const answer = await prompt(`${message} (y/n):`);
  return answer.toLowerCase() === 'y' || answer.toLowerCase() === 'yes';
}

async function select(message: string, options: string[]): Promise<string> {
  console.log(`\n${message}`);
  options.forEach((option, index) => {
    console.log(`  ${index + 1}. ${option}`);
  });
  
  const answer = await prompt("Select option (number):");
  const index = parseInt(answer) - 1;
  
  if (index >= 0 && index < options.length) {
    return options[index];
  }
  
  console.log("Invalid selection, using first option.");
  return options[0];
}

async function getCustomizationAnswers(): Promise<CustomizationAnswers> {
  console.log("üé® Welcome to Deno 2 Starter Customization!");
  console.log("Let's set up your project with some basic information.\n");

  const siteName = await prompt("üìù What is your site/app name? (e.g., 'My Awesome App'):");
  
  const siteDescription = await prompt("üìÑ Describe your app in one sentence:");

  const colorOptions = Object.keys(colors);
  const selectedColor = await select("üé® Choose your primary brand color:", colorOptions);
  const primaryColor = colors[selectedColor as keyof typeof colors];

  console.log("\nüöÄ Feature Configuration:");
  const enableNotifications = await confirm("Enable real-time notifications?");
  const enableTwoFactor = await confirm("Enable two-factor authentication?");
  const enableAdminPanel = await confirm("Enable admin panel?");

  return {
    siteName: siteName || "My App",
    siteDescription: siteDescription || "A modern web application",
    primaryColor,
    enableNotifications,
    enableTwoFactor,
    enableAdminPanel,
  };
}

function generateConfig(answers: CustomizationAnswers): string {
  return `/**
 * Site Configuration
 * Centralized configuration for the Deno 2 Starter template
 * 
 * ‚ö†Ô∏è  CUSTOMIZED: This file was generated by the customization script
 * ‚úèÔ∏è  To make further changes, edit this file directly or run: deno run scripts/customize.ts
 */

export interface NavigationItem {
  label: string;
  href: string;
  icon?: string;
  external?: boolean;
  adminOnly?: boolean;
  requiresAuth?: boolean;
}

export interface SiteConfig {
  // Site Identity
  site: {
    name: string;
    description: string;
    url: string;
    logo?: string;
  };

  // Navigation Configuration
  navigation: {
    primary: NavigationItem[];
    mobile: NavigationItem[];
    footer?: NavigationItem[];
  };

  // Brand Colors & Theme
  theme: {
    primary: string;
    secondary: string;
    accent: string;
    background: string;
    surface: string;
  };

  // Feature Flags
  features: {
    enableNotifications: boolean;
    enableTwoFactor: boolean;
    enableFileUpload: boolean;
    enableAdminPanel: boolean;
    enableDarkMode: boolean;
  };

  // API Configuration
  api: {
    baseUrl: string;
    timeout: number;
    retries: number;
  };

  // Social Links
  social?: {
    github?: string;
    twitter?: string;
    linkedin?: string;
    discord?: string;
  };
}

// üé® Your Customized Configuration
export const defaultConfig: SiteConfig = {
  site: {
    name: "${answers.siteName}",
    description: "${answers.siteDescription}",
    url: "http://localhost:3000",
  },

  navigation: {
    primary: [
      {
        label: "Home",
        href: "/",
        icon: "üè†",
      },
      {
        label: "Design System",
        href: "/design-system",
        icon: "üé®",
      },
      {
        label: "Documentation",
        href: "/docs",
        icon: "üìö",
      },
    ],
    mobile: [
      {
        label: "Home",
        href: "/",
        icon: "üè†",
      },
      {
        label: "Design System",
        href: "/design-system",
        icon: "üé®",
      },
      {
        label: "Documentation",
        href: "/docs",
        icon: "üìö",
      },
    ],
    footer: [
      {
        label: "Privacy Policy",
        href: "/privacy",
      },
      {
        label: "Terms of Service",
        href: "/terms",
      },
      {
        label: "Contact",
        href: "/contact",
      },
    ],
  },

  theme: {
    primary: "${answers.primaryColor}",
    secondary: "#64748b", // slate-500
    accent: "#7c3aed", // violet-600
    background: "#ffffff",
    surface: "#f8fafc", // slate-50
  },

  features: {
    enableNotifications: ${answers.enableNotifications},
    enableTwoFactor: ${answers.enableTwoFactor},
    enableFileUpload: true,
    enableAdminPanel: ${answers.enableAdminPanel},
    enableDarkMode: false,
  },

  api: {
    baseUrl: "http://localhost:8000/api",
    timeout: 10000,
    retries: 3,
  },

  social: {
    // github: "https://github.com/your-username/your-repo",
    // twitter: "https://twitter.com/your-handle",
  },
};

// Environment-specific overrides
const getEnvironmentConfig = (): Partial<SiteConfig> => {
  const env = Deno.env.get("DENO_ENV") || "development";

  switch (env) {
    case "production":
      return {
        site: {
          ...defaultConfig.site,
          url: Deno.env.get("FRONTEND_URL") || "https://your-domain.com",
        },
        api: {
          ...defaultConfig.api,
          baseUrl: Deno.env.get("API_URL") || "https://api.your-domain.com",
        },
      };

    case "staging":
      return {
        site: {
          ...defaultConfig.site,
          name: \`\${defaultConfig.site.name} (Staging)\`,
          url: Deno.env.get("FRONTEND_URL") || "https://staging.your-domain.com",
        },
        api: {
          ...defaultConfig.api,
          baseUrl: Deno.env.get("API_URL") || "https://api-staging.your-domain.com",
        },
      };

    default: // development
      return {};
  }
};

// Merge default config with environment-specific overrides
export const siteConfig: SiteConfig = {
  ...defaultConfig,
  ...getEnvironmentConfig(),
};

// Helper functions for accessing config
export const getSiteName = () => siteConfig.site.name;
export const getSiteUrl = () => siteConfig.site.url;
export const getNavigationItems = () => siteConfig.navigation.primary;
export const getMobileNavigationItems = () => siteConfig.navigation.mobile;
export const getTheme = () => siteConfig.theme;
export const getFeatures = () => siteConfig.features;
export const getApiConfig = () => siteConfig.api;
`;
}

async function writeConfig(configContent: string) {
  const configPath = "./frontend/lib/config.ts";
  
  // Backup existing config
  try {
    const existingConfig = await Deno.readTextFile(configPath);
    await Deno.writeTextFile(`${configPath}.backup`, existingConfig);
    console.log(`üíæ Backed up existing config to ${configPath}.backup`);
  } catch {
    // No existing config to backup
  }

  // Write new config
  await Deno.writeTextFile(configPath, configContent);
  console.log(`‚úÖ Configuration written to ${configPath}`);
}

async function main() {
  try {
    const answers = await getCustomizationAnswers();
    
    console.log("\nüìã Configuration Summary:");
    console.log(`   Site Name: ${answers.siteName}`);
    console.log(`   Description: ${answers.siteDescription}`);
    console.log(`   Primary Color: ${answers.primaryColor}`);
    console.log(`   Notifications: ${answers.enableNotifications ? 'Enabled' : 'Disabled'}`);
    console.log(`   Two-Factor Auth: ${answers.enableTwoFactor ? 'Enabled' : 'Disabled'}`);
    console.log(`   Admin Panel: ${answers.enableAdminPanel ? 'Enabled' : 'Disabled'}`);
    
    const proceed = await confirm("\n‚ú® Apply this configuration?");
    
    if (proceed) {
      const configContent = generateConfig(answers);
      await writeConfig(configContent);
      
      console.log("\nüéâ Customization complete!");
      console.log("\nüìñ Next steps:");
      console.log("   1. Start the dev server: deno task dev");
      console.log("   2. Visit http://localhost:3000 to see your changes");
      console.log("   3. Read docs/CUSTOMIZATION.md for advanced options");
      console.log("   4. Update your README.md with project details");
    } else {
      console.log("\n‚ùå Customization cancelled.");
    }
    
  } catch (error) {
    console.error("‚ùå Error during customization:", error.message);
    Deno.exit(1);
  }
}

if (import.meta.main) {
  main();
}
